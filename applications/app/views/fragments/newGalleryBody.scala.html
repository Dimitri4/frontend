@(gallery: model.Gallery, related: model.RelatedContent, index: Int)(implicit request: RequestHeader)

@import common.{Edition, LinkTo}
@import layout.ContentWidths.GalleryMedia
@import views.support.TrailCssClasses.toneClass
@import views.support.{ImgSrc, RenderClasses}

<div class="l-side-margins l-side-margins--media l-side-margins--new-gallery">

    <article id="article" class="@RenderClasses(
            Map("content--advertisement-feature" -> gallery.commercial.isAdvertisementFeature,
                "paid-content--advertisement-feature" -> gallery.commercial.isAdvertisementFeature
            ),
            "content", "content--media", "content--gallery", "tonal", "new-gallery", "content--immersive", s"tonal--${toneClass(gallery)}"
        )"
        itemscope itemtype="@gallery.metadata.schemaType" role="main">

        @if(gallery.commercial.isAdvertisementFeature){
            @fragments.guBand()
        }

        @fragments.galleryHeader(gallery, gallery.commercial.isSponsored(Some(Edition(request))) || gallery.commercial.isFoundationSupported || gallery.commercial.isAdvertisementFeature)

        <div class="content__main tonal__main tonal__main--@toneClass(gallery)">
            <div class="gs-container">
                <div class="content__main-column content__main-column--gallery">
                    @fragments.witnessCallToAction(gallery.content)
                    <ul class="gallery">
                        @gallery.lightbox.largestCrops.zipWithRowInfo.map { case (image, row) =>
                            @galleryItem(Seq("inline1", "inline2"), 4, image, row.rowNum, gallery.lightbox.imageContainer(row.rowNum - 1))
                        }
                    </ul>
                    @fragments.witnessCallToAction(gallery.content)
                    @fragments.submeta(gallery)
                </div>
            </div>
        </div>
    </article>

    @if(gallery.content.showInRelated &&
        !gallery.commercial.isAdvertisementFeature ) {
        <div class="gallery__most-popular facia-container fc-container fc-container--media hide-on-childrens-books-site js-gallery-most-popular tonal--@toneClass(gallery)">
            <div class="fc-container__inner">
                <div class="fc-container__header">
                    <h2 class="fc-container__header__title">
                        <a class="most-viewed-no-js tone-colour" href="@LinkTo{/gallery/most-viewed}" data-link-name="Most viewed galleries">More galleries</a>
                    </h2>
                </div>
            </div>
        </div>
    }
    @fragments.contentFooter(gallery, related, "media")
</div>

@galleryItem(adSlots: Seq[String], adInterval: Int, image: model.ImageAsset, rowNum: Int, imageElement: model.ImageElement) = {

    <li id="img-@rowNum" class="gallery__item js-gallery-item" data-link-name="Gallery item | @rowNum">
        <figure itemscope itemtype="http://schema.org/ImageObject">

            <div class="gallery__figcaption">
                @image.caption.map { caption =>
                    <p class="gallery__caption" itemprop="caption">@Html(caption)</p>
                }
                @if(image.displayCredit) {
                    @image.credit.map { credit =>
                        <p class="gallery__credit" itemprop="author">@credit</p>
                    }
                }

                @fragments.share.blockLevelSharing("img-" + rowNum.toString, gallery.sharelinks.elementShares("img-" + rowNum.toString, image.path), gallery.metadata.contentType, isNewGallery = true)
            </div>

            <a class="gallery__img-container gallery__img-container@if(image.width >= image.height) {--landscape} else {--portrait} js-gallerythumbs"
                href="@LinkTo{@gallery.metadata.url#img-@rowNum}"
                data-link-name="Launch Gallery Lightbox" data-is-ajax>

                <picture>
                    @* IE 9 needs this workaround as per https://scottjehl.github.io/picturefill/ *@
                        <!--[if IE 9]><video style="display: none;"><![endif]-->
                    @defining({
                        GalleryMedia.inline
                    }) { widths =>
                        @widths.breakpoints.map { breakpointWidth =>
                            <source media="(min-width: @breakpointWidth.breakpoint.minWidth.getOrElse("0")px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: @breakpointWidth.breakpoint.minWidth.getOrElse("0")px) and (min-resolution: 120dpi)"
                            sizes="@breakpointWidth.width"
                            srcset="@ImgSrc.srcsetForBreakpoint(breakpointWidth, widths.breakpoints, maybePath = None, maybeImageMedia = Some(imageElement.images), hidpi = true)" />
                            <source media="(min-width: @breakpointWidth.breakpoint.minWidth.getOrElse("0")px)"
                            sizes="@breakpointWidth.width"
                            srcset="@ImgSrc.srcsetForBreakpoint(breakpointWidth, widths.breakpoints, maybePath = None, maybeImageMedia = Some(imageElement.images))" />
                        }
                    }

                    <!--[if IE 9]></video><![endif]-->

                    <img class="gallery__img gallery__img@if(image.width >= image.height) {--landscape} else {--portrait}"
                    itemprop="contentUrl"
                        style="max-width: calc(@{image.width.toFloat/image.height} * 96vh)"
                    alt="@image.altText.getOrElse("")"
                    src="@ImgSrc.getFallbackUrl(imageElement.images)" />
                </picture>
            </a>
        </figure>
    </li>

    @if(!gallery.content.shouldHideAdverts && rowNum % adInterval == 0) {
        @adSlots.lift((rowNum / adInterval) - 1).map { adSlot =>
            <li class="gallery__item gallery__item--advert">
                <div class="gallery__img-container">
                    @defining(if(adSlot == "inline1") Option("300,250") else None) { mpuSlotSize =>
                        @fragments.commercial.standardAd(
                            adSlot,
                            Seq("gallery-inline", "dark"),
                            Map(
                                "mobile" -> (Seq("1,1", "300,50") ++ mpuSlotSize),
                                "mobile-landscape" -> (Seq("1,1", "300,50", "320,50") ++ mpuSlotSize),
                                "tablet" -> Seq("1,1", "300,250")
                            )
                        )
                    }
                </div>
            </li>
        }
    }
}
